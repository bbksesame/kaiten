<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–£—á—ë—Ç –ø–µ—Ä–µ—Ä—ã–≤–æ–≤ (–∫–∞–Ω–±–∞–Ω)</title>

  <!-- —Å–∫—Ä—ã—Ç—å "–ù–æ–≤—ã–π –¥–µ–Ω—å" (–∫–∞–∫ —É —Ç–µ–±—è –±—ã–ª–æ) -->
  <style>#btnNewDay{display:none !important;}</style>

  <style>
    :root{
      --bg:#151922;--panel:#1d2330;--card:#262f40;--text:#e9edf4;--muted:#a2adbb;--accent:#7aa2ff;
      --ok:#33d17a;--border:#414a60;--dash:#343c52;--timer:#b6f0b6;--btn:#2b3346;--btn-border:#3e4863;--btn-hover:#33405a;
      --danger:#3a1f25;--danger-b:#6c2b37;--card-52:#2a3446;--border-52:#465270;--card-22:#28303f;--border-22:#3e465a;
      --card-night:#26293b;--border-night:#444768;--clock:#fff4c2;--scroll:#1c2331;--red:#e01b24;--yellow:#f6d32d;--green:#33d17a;
      --chip-bg:#222838;--chip-border:#3a4257;
    }
    [data-theme="light"]{
      --bg:#f5f6fa;--panel:#ffffff;--card:#ffffff;--text:#1f2430;--muted:#5b6475;--accent:#3b82f6;
      --ok:#22c55e;--border:#d1d5e2;--dash:#e1e4f0;--timer:#15803d;--btn:#eef0f7;--btn-border:#d4d7e5;--btn-hover:#e0e3f0;
      --danger:#fef2f2;--danger-b:#fecaca;--card-52:#f1f5f9;--border-52:#cbd5f5;--card-22:#f9fafb;--border-22:#e5e7eb;
      --card-night:#f5f3ff;--border-night:#ddd6fe;--clock:#92400e;--scroll:#e5e7f2;--red:#dc2626;--yellow:#eab308;--green:#16a34a;
      --chip-bg:#f3f4ff;--chip-border:#c7d2fe;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      margin:0;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",system-ui,sans-serif;
      background:radial-gradient(circle at top,#22263a 0,#151922 42%,#11131b 100%);
      color:var(--text);min-height:100vh;display:flex;flex-direction:column;
    }
    body::before{
      content:"";position:fixed;inset:0;pointer-events:none;
      background:
        radial-gradient(circle at 0 0,rgba(122,162,255,.12),transparent 55%),
        radial-gradient(circle at 100% 0,rgba(51,209,122,.08),transparent 60%),
        radial-gradient(circle at 0 100%,rgba(250,204,21,.05),transparent 55%);
      opacity:.9;mix-blend-mode:screen;z-index:-1;
    }
    .app{
      display:flex;flex-direction:column;gap:10px;max-width:1320px;margin:0 auto;padding:10px 10px 24px;
      width:100%;position:relative;z-index:1;
    }
    header{
      display:flex;align-items:center;justify-content:space-between;margin:6px 2px 2px;
      gap:10px;flex-wrap:wrap;
    }
    header h1{
      font-size:20px;font-weight:650;letter-spacing:.02em;display:flex;align-items:center;gap:8px;
    }
    .logo-dot{
      width:8px;height:8px;border-radius:999px;background:linear-gradient(135deg,#4f46e5,#22c55e);
      box-shadow:0 0 0 4px rgba(79,70,229,.18);
    }
    .header-sub{
      font-size:11px;color:var(--muted);margin-top:1px;
    }
    .header-right{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;
    }
    .pill{
      border-radius:999px;border:1px solid var(--border);padding:6px 10px;font-size:11px;
      display:inline-flex;align-items:center;gap:6px;background:rgba(15,23,42,.7);backdrop-filter:blur(18px);
      box-shadow:0 12px 30px rgba(15,23,42,.55),0 0 0 1px rgba(148,163,184,.08);
    }
    [data-theme="light"] .pill{
      background:rgba(255,255,255,.9);box-shadow:0 8px 20px rgba(15,23,42,.12);
    }
    .pill-label{color:var(--muted);font-size:11px;}
    .pill-value{font-weight:600;font-size:12px;}
    .status-dot{
      width:7px;height:7px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%,#bbf7d0,#22c55e);
      box-shadow:0 0 0 4px rgba(34,197,94,.15);
    }
    .btn{
      border-radius:999px;border:1px solid var(--btn-border);background:var(--btn);
      padding:6px 10px;font-size:12px;display:inline-flex;align-items:center;
      gap:6px;cursor:pointer;color:var(--text);box-shadow:0 4px 12px rgba(15,23,42,.6);
      transition:.15s background,.15s transform,.15s box-shadow,.15s border-color;
    }
    .btn:hover{
      background:var(--btn-hover);
      transform:translateY(-1px);
      box-shadow:0 8px 18px rgba(15,23,42,.85);
      border-color:var(--accent);
    }
    .btn:active{
      transform:translateY(0);
      box-shadow:0 4px 10px rgba(15,23,42,.7);
    }
    .btn-ghost{
      background:transparent;border-color:var(--border);box-shadow:none;color:var(--muted);
    }
    .btn-ghost:hover{
      background:rgba(148,163,184,.06);border-color:var(--accent);color:var(--text);
      box-shadow:0 0 0 1px rgba(59,130,246,.35);
    }
    .btn-icon{
      width:18px;height:18px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,rgba(148,163,184,.16),rgba(51,65,85,.9));
      box-shadow:0 0 0 1px rgba(30,64,175,.45),0 0 20px rgba(37,99,235,.45);
      font-size:11px;font-weight:600;
    }
    .btn-text{font-weight:500;}
    .btn-small{
      padding:4px 8px;font-size:11px;
    }
    main{
      display:flex;flex-direction:column;gap:8px;flex:1;
    }
    .board-wrap{
      display:flex;flex-direction:column;gap:6px;min-height:0;
      border-radius:18px;padding:10px 10px 12px;
      background:radial-gradient(circle at top,#1f2435,#151822 46%,#10131b 100%);
      border:1px solid rgba(148,163,184,.2);
      box-shadow:
        0 24px 60px rgba(15,23,42,.85),
        0 0 0 1px rgba(148,163,184,.18),
        inset 0 0 0 1px rgba(15,23,42,.9);
      position:relative;overflow:hidden;
    }
    [data-theme="light"] .board-wrap{
      background:radial-gradient(circle at top,#e5e7f5,#f5f7ff 38%,#edf1ff 100%);
      border-color:rgba(148,163,184,.4);
      box-shadow:0 20px 40px rgba(15,23,42,.16),0 0 0 1px rgba(148,163,184,.22);
    }
    .board-wrap::before{
      content:"";position:absolute;inset:0;pointer-events:none;
      background:
        linear-gradient(to bottom,rgba(148,163,184,.24),transparent 23%);
      mix-blend-mode:soft-light;opacity:.65;
    }
    .board-wrap-inner{
      position:relative;z-index:1;display:flex;flex-direction:column;gap:6px;min-height:0;
    }
    .board-header{
      display:flex;align-items:center;gap:8px;justify-content:space-between;flex-wrap:wrap;
    }
    .board-title{
      display:flex;align-items:center;gap:8px;font-size:13px;font-weight:600;
    }
    .board-title-chip{
      font-size:11px;color:var(--muted);font-weight:400;display:flex;align-items:center;gap:4px;
      padding:3px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.35);
      background:radial-gradient(circle at top left,rgba(129,140,248,.26),rgba(15,23,42,.9));
      box-shadow:0 10px 30px rgba(15,23,42,.9);
    }
    [data-theme="light"] .board-title-chip{
      background:radial-gradient(circle at top left,rgba(129,140,248,.2),rgba(255,255,255,.88));
      box-shadow:0 10px 22px rgba(15,23,42,.12);
    }
    .board-controls{
      display:flex;align-items:center;gap:6px;flex-wrap:wrap;
    }
    .chips{
      display:flex;flex-wrap:wrap;gap:4px;margin:4px 0 2px;
    }
    .chip{
      display:inline-flex;align-items:center;gap:4px;
      padding:3px 6px;border-radius:999px;
      font-size:11px;border:1px solid var(--chip-border);
      background:radial-gradient(circle at top left,rgba(30,64,175,.4),var(--chip-bg));
      color:var(--muted);cursor:pointer;
      box-shadow:0 6px 16px rgba(15,23,42,.6);
      transition:.14s background,.14s transform,.14s box-shadow,.14s border-color,.14s color;
    }
    .chip span:last-child{
      font-weight:600;color:var(--text);font-variant-numeric:tabular-nums;
    }
    .chip:hover{
      transform:translateY(-1px);border-color:var(--accent);
      background:radial-gradient(circle at top left,rgba(59,130,246,.55),var(--chip-bg));
      box-shadow:0 10px 24px rgba(15,23,42,.9);
      color:var(--text);
    }
    .board{
      display:flex;gap:8px;overflow-x:auto;padding:4px 2px 4px 0;
      min-height:300px;max-height:calc(100vh - 210px);
      scrollbar-width:thin;
    }
    .board::-webkit-scrollbar{
      height:6px;
    }
    .board::-webkit-scrollbar-track{
      background:transparent;
    }
    .board::-webkit-scrollbar-thumb{
      background:var(--scroll);border-radius:999px;
    }
    .col{
      flex:0 0 240px;display:flex;flex-direction:column;gap:6px;
      background:linear-gradient(to bottom,var(--card) 0,rgba(15,23,42,.98) 100%);
      border-radius:18px;border:1px solid var(--border);padding:7px 6px 7px;
      box-shadow:0 18px 40px rgba(15,23,42,.9),0 0 0 1px rgba(148,163,184,.16);
      position:relative;overflow:hidden;
    }
    [data-theme="light"] .col{
      background:linear-gradient(to bottom,var(--card),#eef1ff);
      box-shadow:0 14px 30px rgba(15,23,42,.12);
    }
    .col h3{
      font-size:12px;font-weight:600;padding:3px 6px 1px;display:flex;justify-content:space-between;align-items:center;
    }
    .col h3 span:last-child{
      font-size:11px;color:var(--muted);font-variant-numeric:tabular-nums;
      padding:0 6px;border-radius:999px;border:1px solid rgba(148,163,184,.4);
      background:radial-gradient(circle at top,rgba(148,163,184,.28),rgba(15,23,42,0));
    }
    .col .drop{
      margin-top:4px;display:flex;flex-direction:column;gap:6px;min-height:46px;
    }
    .card{
      border-radius:14px;border:1px solid var(--border);padding:6px 6px 5px;
      background:radial-gradient(circle at top,rgba(148,163,184,.22),rgba(15,23,42,.98));
      box-shadow:0 12px 26px rgba(15,23,42,.9),0 0 0 1px rgba(148,163,184,.16);
      cursor:grab;user-select:none;
      display:flex;flex-direction:column;gap:3px;position:relative;overflow:hidden;
    }
    .card.dragging{
      opacity:.4;transform:scale(.98);
    }
    .card-header{
      display:flex;align-items:center;justify-content:space-between;gap:6px;
    }
    .badge{
      font-size:11px;border-radius:999px;padding:2px 7px 2px;
      background:rgba(15,23,42,.7);border:1px solid rgba(148,163,184,.35);
      color:var(--muted);display:inline-flex;align-items:center;gap:5px;
    }
    .badge-dot{
      width:6px;height:6px;border-radius:999px;background:var(--accent);
      box-shadow:0 0 0 3px rgba(59,130,246,.45);
    }
    .name{
      font-size:13px;font-weight:600;
    }
    .meta{
      display:flex;flex-wrap:wrap;gap:4px;margin-top:2px;
    }
    .meta span{
      font-size:11px;color:var(--muted);display:inline-flex;align-items:center;gap:4px;
    }
    .timer{
      font-variant-numeric:tabular-nums;font-size:11px;
      color:var(--timer);font-weight:500;display:inline-flex;align-items:center;gap:4px;
    }
    .timer-dot{
      width:5px;height:5px;border-radius:999px;background:var(--timer);
      box-shadow:0 0 0 3px rgba(182,240,182,.18);
    }
    .shift-pill{
      font-size:10px;border-radius:999px;padding:2px 6px;
      border:1px solid var(--border);color:var(--muted);margin-left:auto;
      background:rgba(15,23,42,.7);
    }
    .shift-52{background:var(--card-52);border-color:var(--border-52);}
    .shift-22{background:var(--card-22);border-color:var(--border-22);}
    .shift-night{background:var(--card-night);border-color:var(--border-night);}
    .status-label{
      position:absolute;right:6px;bottom:5px;font-size:10px;color:var(--muted);
      opacity:.8;
    }
    .status-label span{
      padding:1px 5px;border-radius:999px;border:1px solid rgba(148,163,184,.45);
      background:rgba(15,23,42,.8);
    }
    .status-limit{
      font-size:10px;color:var(--muted);margin-top:2px;
    }
    .danger-card{
      border-color:var(--danger-b);background:radial-gradient(circle at top,rgba(248,113,113,.18),rgba(15,23,42,.98));
      box-shadow:0 16px 34px rgba(127,29,29,.9);
    }
    .danger-card .timer{color:#fecaca;}
    .danger-card .timer-dot{background:#fecaca;box-shadow:0 0 0 3px rgba(254,202,202,.25);}
    .summary{
      display:flex;flex-wrap:wrap;gap:6px;margin-top:2px;
    }
    .summary-title{
      font-size:11px;color:var(--muted);margin-right:8px;
    }
    .summary-item{
      font-size:11px;color:var(--muted);display:inline-flex;align-items:center;gap:4px;
    }
    .summary-item strong{
      font-variant-numeric:tabular-nums;
    }
    .avatar{
      width:22px;height:22px;border-radius:999px;overflow:hidden;margin-right:4px;
      flex-shrink:0;border:1px solid rgba(148,163,184,.6);
      box-shadow:0 0 0 1px rgba(15,23,42,1),0 0 20px rgba(148,163,184,.5);
      background:radial-gradient(circle at top,rgba(148,163,184,.35),rgba(15,23,42,1));
      display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;
    }
    .avatar img{
      width:100%;height:100%;object-fit:cover;display:block;
    }
    .avatar span{color:var(--text);}
    .toolbar{
      display:flex;align-items:center;gap:6px;margin-top:2px;flex-wrap:wrap;
    }
    .toolbar button{
      border-radius:999px;border:1px solid var(--btn-border);background:var(--btn);
      padding:3px 8px;font-size:11px;color:var(--muted);display:inline-flex;align-items:center;gap:4px;cursor:pointer;
      box-shadow:0 4px 10px rgba(15,23,42,.7);
    }
    .toolbar button span:first-child{
      width:14px;height:14px;border-radius:999px;border:1px solid rgba(148,163,184,.6);
      display:inline-flex;align-items:center;justify-content:center;font-size:9px;
    }
    .toolbar button:hover{
      background:var(--btn-hover);color:var(--text);border-color:var(--accent);
    }
    .status-overflow{
      font-size:11px;color:var(--red);margin-top:2px;
    }
    .limit-ok{color:var(--green);}
    .limit-warn{color:var(--yellow);}
    .limit-bad{color:var(--red);}
    .small{
      font-size:11px;color:var(--muted);
    }
    .offline{
      opacity:.7;filter:grayscale(.2);
    }
    .clock-pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;border:1px solid var(--border);
      background:rgba(15,23,42,.9);font-size:12px;color:var(--clock);
      box-shadow:0 10px 24px rgba(15,23,42,.9),0 0 0 1px rgba(148,163,184,.18);
    }
    [data-theme="light"] .clock-pill{
      background:rgba(255,255,255,.95);color:#92400e;
      box-shadow:0 8px 18px rgba(15,23,42,.12);
    }
    .clock-icon{
      width:16px;height:16px;border-radius:999px;
      border:1px solid rgba(251,191,36,.7);
      display:inline-flex;align-items:center;justify-content:center;font-size:11px;
      background:radial-gradient(circle at 30% 30%,#fef9c3,#facc15);
      box-shadow:0 0 0 1px rgba(180,83,9,.55),0 0 18px rgba(250,204,21,.6);
    }
    .clock-time{font-variant-numeric:tabular-nums;}
    .clock-date{font-size:11px;color:var(--muted);}
    .grid-footer{
      display:flex;justify-content:space-between;align-items:center;margin-top:4px;
      font-size:11px;color:var(--muted);gap:8px;flex-wrap:wrap;
    }
    .legend{
      display:flex;align-items:center;gap:12px;flex-wrap:wrap;
    }
    .legend-item{
      display:inline-flex;align-items:center;gap:5px;
    }
    .legend-dot{
      width:10px;height:10px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%,#f97316,#b45309);
      box-shadow:0 0 0 3px rgba(234,88,12,.35);
    }
    .legend-dot.green{
      background:radial-gradient(circle at 30% 30%,#22c55e,#15803d);
      box-shadow:0 0 0 3px rgba(34,197,94,.35);
    }
    .legend-dot.red{
      background:radial-gradient(circle at 30% 30%,#ef4444,#991b1b);
      box-shadow:0 0 0 3px rgba(239,68,68,.35);
    }
    .legend-label{
      font-size:11px;color:var(--muted);
    }
    .footer-right{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;
    }
    .theme-switch{
      display:inline-flex;align-items:center;gap:6px;font-size:11px;color:var(--muted);cursor:pointer;
    }
    .theme-switch-toggle{
      width:32px;height:16px;border-radius:999px;border:1px solid var(--border);
      background:rgba(15,23,42,.9);position:relative;box-shadow:0 4px 10px rgba(15,23,42,.9);
    }
    [data-theme="light"] .theme-switch-toggle{
      background:#e5e7eb;
    }
    .theme-switch-thumb{
      position:absolute;top:1px;left:1px;width:12px;height:12px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%,#f9fafb,#e5e7eb);
      box-shadow:0 0 0 1px rgba(15,23,42,.55),0 0 12px rgba(148,163,184,.65);
      transition:.16s transform;
    }
    [data-theme="light"] .theme-switch-thumb{
      transform:translateX(14px);background:radial-gradient(circle at 30% 30%,#fef9c3,#facc15);
      box-shadow:0 0 0 1px rgba(180,83,9,.6),0 0 14px rgba(250,204,21,.7);
    }
    .login-subtitle{
      font-size:12px;color:var(--muted);margin:4px 0 0;
    }
    .empty{
      margin-top:6px;font-size:12px;color:var(--muted);
    }
    .cards-counter{
      font-size:11px;color:var(--muted);
    }
    .slot-result{
      margin-top:6px;
      font-size:12px;
      opacity:.9;
    }

    /* –ü–ª–∞—à–∫–∞-–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ –ø–µ—Ä–µ—Ä—ã–≤–æ–≤ */
    .break-toggle{
      margin:4px 8px 6px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid transparent;
      font-size:12px;
      font-weight:500;
      cursor:pointer;
      background:var(--btn);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .break-toggle--single{
      background:var(--danger-b);
      border-color:var(--danger-b);
      color:#ffd9cd;
    }
    .break-toggle--double{
      background:var(--ok);
      border-color:var(--ok);
      color:#04120a;
    }
  </style>
</head>
<body data-theme="dark">

<!-- LOGIN -->
<div id="login">
  <div class="box" style="max-width:420px;margin:80px auto;background:rgba(15,23,42,.96);border-radius:20px;padding:18px 18px 16px;border:1px solid rgba(148,163,184,.4);box-shadow:0 24px 60px rgba(15,23,42,.9);">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:10px;">
      <div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="logo-dot"></div>
          <div>
            <div style="font-size:15px;font-weight:650;letter-spacing:.02em;">–£—á—ë—Ç –ø–µ—Ä–µ—Ä—ã–≤–æ–≤</div>
            <div class="login-subtitle">–í—Ö–æ–¥ –ø–æ –∫–æ–¥—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</div>
          </div>
        </div>
      </div>
      <div style="text-align:right;font-size:11px;color:var(--muted);">
        <div>–°–º–µ–Ω–∞: <span id="loginShiftLabel">‚Äî</span></div>
        <div id="loginDateLabel">‚Äî</div>
      </div>
    </div>
    <div style="margin-top:10px;">
      <label style="display:block;font-size:12px;margin-bottom:4px;color:var(--muted);">–ö–æ–¥ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</label>
      <input id="code" maxlength="6" inputmode="numeric" autocomplete="one-time-code"
             style="width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:rgba(15,23,42,.95);color:var(--text);font-size:14px;outline:none;box-shadow:0 8px 20px rgba(15,23,42,.8);"
             placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 123456">
      <div id="loginError" style="margin-top:6px;font-size:11px;color:var(--red);display:none;"></div>
    </div>
    <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;gap:10px;">
      <button id="btnLogin" class="btn" style="flex:1;justify-content:center;">
        <span class="btn-icon">‚Üí</span><span class="btn-text">–í–æ–π—Ç–∏</span>
      </button>
      <button id="btnThemeLogin" class="btn btn-ghost btn-small" type="button">
        <span class="btn-icon" style="width:16px;height:16px;font-size:10px;">‚òæ</span>
        <span class="btn-text" style="font-size:11px;">–¢–µ–º–∞</span>
      </button>
    </div>
  </div>
</div>

<!-- APP -->
<div class="app" id="app" style="display:none;">
  <header>
    <div>
      <h1><span class="logo-dot"></span>–£—á—ë—Ç –ø–µ—Ä–µ—Ä—ã–≤–æ–≤</h1>
      <div class="header-sub">–ñ–∏–≤–æ–π –¥–∞—à–±–æ—Ä–¥ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤</div>
    </div>
    <div class="header-right">
      <div class="pill">
        <span class="status-dot"></span>
        <div style="display:flex;flex-direction:column;">
          <span class="pill-label">–°–µ–π—á–∞—Å –Ω–∞ –ª–∏–Ω–∏–∏</span>
          <span class="pill-value"><span id="onlineCount">0</span> –æ–ø–µ—Ä–∞—Ç–æ—Ä(–æ–≤)</span>
        </div>
      </div>
      <div class="pill">
        <div style="display:flex;flex-direction:column;">
          <span class="pill-label">–ú–æ—è —Å–º–µ–Ω–∞</span>
          <span class="pill-value" id="myShiftLabel">‚Äî</span>
        </div>
      </div>
      <div class="clock-pill">
        <span class="clock-icon">‚è±</span>
        <div style="display:flex;flex-direction:column;gap:1px;">
          <span class="clock-time" id="clockTime">--:--</span>
          <span class="clock-date" id="clockDate">--</span>
        </div>
      </div>
      <button id="btnNewDay" class="btn btn-ghost btn-small" type="button">
        <span class="btn-icon" style="width:16px;height:16px;font-size:10px;">‚òÖ</span>
        <span class="btn-text" style="font-size:11px;">–ù–æ–≤—ã–π –¥–µ–Ω—å</span>
      </button>
      <button id="btnLogout" class="btn btn-ghost btn-small" type="button">
        <span class="btn-icon" style="width:16px;height:16px;font-size:10px;">‚Ü©</span>
        <span class="btn-text" style="font-size:11px;">–í—ã–π—Ç–∏</span>
      </button>
    </div>
  </header>

  <main>
    <div class="board-wrap">
      <div class="board-wrap-inner">
        <div class="board-header">
          <div class="board-title">
            <span>–°—Ç–∞—Ç—É—Å—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤</span>
            <div class="board-title-chip">
              <span style="width:14px;height:14px;border-radius:999px;border:1px solid rgba(129,140,248,.6);display:inline-flex;align-items:center;justify-content:center;font-size:9px;">‚àû</span>
              <span>–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫</span>
            </div>
          </div>
          <div class="board-controls">
            <div class="cards-counter">
              –í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤: <strong id="totalOperators">0</strong>
            </div>
            <button id="btnRefresh" class="btn btn-small" type="button">
              <span class="btn-icon" style="width:16px;height:16px;font-size:10px;">‚ü≥</span>
              <span class="btn-text" style="font-size:11px;">–û–±–Ω–æ–≤–∏—Ç—å</span>
            </button>
            <button id="btnTheme" class="btn btn-ghost btn-small" type="button">
              <span class="btn-icon" style="width:16px;height:16px;font-size:10px;">‚òæ</span>
            </button>
          </div>
        </div>

        <div class="chips" id="summaryChips"></div>

        <div class="board" id="appBoard">
          <div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤...</div>
        </div>

        <div class="grid-footer">
          <div class="legend">
            <div class="legend-item">
              <span class="legend-dot"></span>
              <span class="legend-label">> 15 –º–∏–Ω—É—Ç –≤ —Å—Ç–∞—Ç—É—Å–µ</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot green"></span>
              <span class="legend-label">–ù–æ—Ä–º–∞</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot red"></span>
              <span class="legend-label">–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ / –¥–æ–ª–≥–∏–π —Å—Ç–∞—Ç—É—Å</span>
            </div>
          </div>
          <div class="footer-right">
            <div class="theme-switch" id="themeSwitch">
              <span>–¢–µ–º–∞</span>
              <div class="theme-switch-toggle"><div class="theme-switch-thumb"></div></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
(function(){
  const state = {
    session:null,
    cards:[],
    statuses:["–ß–∞—Ç—ã","–û–∂–∏–¥–∞–Ω–∏–µ","–ü–µ—Ä–µ—Ä—ã–≤","–û–±–µ–¥","–û–±—É—á–µ–Ω–∏–µ","–°–æ–≤–µ—â–∞–Ω–∏–µ","–î—Ä—É–≥–æ–µ"],
    timers:{},
    lastColumnsHash:{},
    theme:localStorage.getItem('kaiten_theme')||'dark',
  };

  function setTheme(theme){
    state.theme = theme;
    document.body.setAttribute('data-theme', theme);
    localStorage.setItem('kaiten_theme', theme);
    const iconLogin = document.querySelector('#btnThemeLogin .btn-icon');
    const iconMain = document.querySelector('#btnTheme .btn-icon');
    if (iconLogin) iconLogin.textContent = theme === 'dark' ? '‚òæ' : '‚òÄ';
    if (iconMain) iconMain.textContent = theme === 'dark' ? '‚òæ' : '‚òÄ';
  }

  function initTheme(){
    const saved = state.theme;
    setTheme(saved);
  }

  function fmtTime(sec){
    if (sec < 0) sec = 0;
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s = sec%60;
    if (h>0) return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }

  function msToSec(ms){ return Math.floor(ms/1000); }

  async function api(path, opts){
    const headers = { 'Content-Type':'application/json' };
    if (state.session && state.session.token) headers['Authorization'] = 'Bearer ' + state.session.token;
    const res = await fetch(path, { ...opts, headers });
    if (!res.ok){
      let msg = '–û—à–∏–±–∫–∞ ' + res.status;
      try{
        const data = await res.json();
        if (data && data.error) msg = data.error;
      }catch(e){}
      throw new Error(msg);
    }
    return res.json();
  }

  function saveSession(session){
    state.session = session;
    localStorage.setItem('kaiten_session', JSON.stringify(session));
  }

  function loadSession(){
    try{
      const s = localStorage.getItem('kaiten_session');
      if (!s) return null;
      return JSON.parse(s);
    }catch(e){
      return null;
    }
  }

  function clearSession(){
    state.session = null;
    localStorage.removeItem('kaiten_session');
  }

  function renderSummary(byStatus){
    const el = document.getElementById('summaryChips');
    if (!el) return;
    el.innerHTML = '';
    const statuses = state.statuses;
    statuses.forEach(s=>{
      const chip = document.createElement('div'); chip.className='chip';
      chip.innerHTML = `<span>${s}</span><span class="count">${(byStatus[s]||[]).length}</span>`;
      chip.onclick = async ()=>{
        if (!state.session) return;
        const myId = (state.session.operatorId||'').trim(); if (!myId) return;
        const me = (state.cards||[]).find(x=>String(x.id)===String(myId));
        if (me && me.status === s) return;
        await move(myId, s);
      };
      el.appendChild(chip);
    });
  }

  function hashColumn(cards){ return (cards||[]).map(c=>c.id+':' + (c.statusSince||'')).join('|'); }

  function renderColumns(byStatus){
    const root = document.getElementById('appBoard');
    if (!root.dataset.ready){
      root.innerHTML='';
      state.statuses.forEach(s=>{
        const col = document.createElement('div'); col.className='col'; col.dataset.status=s;
        col.innerHTML = `<h3 style="margin:6px 8px 10px">${s} <span class="count">0</span></h3><div class="drop" data-status="${s}"></div>`;
        enableDrop(col.querySelector('.drop')); root.appendChild(col);
      });
      root.dataset.ready='1';

      // –ü–ª–∞—à–∫–∞-–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –Ω–∞–¥ —Å—Ç–æ–ª–±—Ü–æ–º "–ü–µ—Ä–µ—Ä—ã–≤"
      const breakCol = root.querySelector('.col[data-status="–ü–µ—Ä–µ—Ä—ã–≤"]');
      if (breakCol && !breakCol.querySelector('.break-toggle')) {
        const header = breakCol.querySelector('h3');
        const toggle = document.createElement('button');
        toggle.type = 'button';
        toggle.className = 'break-toggle break-toggle--single';
        toggle.dataset.mode = 'single'; // single = –ø–æ –æ–¥–Ω–æ–º—É, double = –ø–æ –¥–≤–æ–µ

        const updateBreakToggle = () => {
          if (toggle.dataset.mode === 'single') {
            toggle.textContent = '–ü–µ—Ä–µ—Ä—ã–≤: –ø–æ –æ–¥–Ω–æ–º—É';
            toggle.classList.add('break-toggle--single');
            toggle.classList.remove('break-toggle--double');
          } else {
            toggle.textContent = '–ü–µ—Ä–µ—Ä—ã–≤: –ø–æ –¥–≤–æ–µ';
            toggle.classList.add('break-toggle--double');
            toggle.classList.remove('break-toggle--single');
          }
        };

        updateBreakToggle();

        toggle.addEventListener('click', () => {
          toggle.dataset.mode = toggle.dataset.mode === 'single' ? 'double' : 'single';
          updateBreakToggle();
        });

        // –≤—Å—Ç–∞–≤–ª—è–µ–º –ø–ª–∞—à–∫—É –ø—Ä—è–º–æ –Ω–∞–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∫–æ–ª–æ–Ω–∫–∏ "–ü–µ—Ä–µ—Ä—ã–≤"
        if (header) breakCol.insertBefore(toggle, header);
        else breakCol.insertBefore(toggle, breakCol.firstChild);
      }

    }
    state.statuses.forEach(s=>{
      const cards = byStatus[s]||[]; const newHash = hashColumn(cards);
      const col = root.querySelector(`.col[data-status="${s.replace(/"/g,'\\"')}"]`); if (!col) return;
      col.querySelector('.count').textContent = String(cards.length);
      if (state.lastColumnsHash[s] === newHash) return;
      state.lastColumnsHash[s] = newHash;
      const drop = col.querySelector('.drop'); drop.innerHTML='';
      const frag = document.createDocumentFragment();
      cards.forEach(c => frag.appendChild(makeCard(c)));
      drop.appendChild(frag);
    });
  }

  function detectShiftClass(shift){
    const s=String(shift||'').toLowerCase();
    if(s==='5/2')return'shift-52';
    if(s==='2/2')return'shift-22';
    if(s.includes('–Ω–æ—á'))return'shift-night';
    return'';
  }

  function makeCard(c){
    const el = document.createElement('div'); el.className='card'; el.dataset.id=c.id;
    const nowSec = msToSec(Date.now()/1 - (c.serverNow||Date.now()));
    const statusSince = c.statusSince ? msToSec((Date.now())/1 - new Date(c.statusSince).getTime()) : 0;
    const dangerous = statusSince > 15*60;
    if (dangerous) el.classList.add('danger-card');
    if (!c.isOnline) el.classList.add('offline');
    const shiftClass = detectShiftClass(c.shift);
    const avatarLetter = (c.name||'?').trim().charAt(0).toUpperCase()||'?';
    el.innerHTML = `
      <div class="card-header">
        <div style="display:flex;align-items:center;gap:6px;">
          <div class="avatar">
            ${c.avatar ? `<img src="${c.avatar}" alt="">` : `<span>${avatarLetter}</span>`}
          </div>
          <div>
            <div class="name">${c.name||'–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
            <div class="meta">
              <span><span style="width:6px;height:6px;border-radius:999px;background:${c.isOnline?'#22c55e':'#ef4444'};display:inline-block;"></span>${c.isOnline?'–û–Ω–ª–∞–π–Ω':'–û—Ñ—Ñ–ª–∞–π–Ω'}</span>
              <span>${c.team||'–ë–µ–∑ –∫–æ–º–∞–Ω–¥—ã'}</span>
            </div>
          </div>
        </div>
        ${c.shift ? `<div class="shift-pill ${shiftClass}">${c.shift}</div>`:``}
      </div>
      <div class="toolbar">
        <button data-action="set-comment"><span>‚úé</span><span>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</span></button>
        <button data-action="add-image"><span>üì∑</span><span>–§–æ—Ç–æ</span></button>
      </div>
      <div class="meta">
        <span class="timer"><span class="timer-dot"></span><span data-role="timer"></span></span>
      </div>
      <div class="status-label"><span>${c.status||'‚Äî'}</span></div>
    `;
    el.querySelectorAll('.toolbar button').forEach(btn=>{
      btn.addEventListener('click', async (ev)=>{
        ev.stopPropagation();
        const action = btn.dataset.action;
        if (action === 'add-image'){
          await handleAddImage(c);
        } else if (action === 'set-comment'){
          const comment = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Å—Ç–∞—Ç—É—Å—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏—á–∏–Ω–∞ –¥–æ–ª–≥–æ–≥–æ –ø–µ—Ä–µ—Ä—ã–≤–∞):', c.comment||'');
          if (comment === null) return;
          try {
            await api('/api/move', {
              method:'POST',
              body: JSON.stringify({ operatorId: c.id, newStatus: c.status, comment })
            });
            await loadBoard();
          } catch (e) {
            alert(e.message||'–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
          }
        }
      });
    });
    const timerEl = el.querySelector('[data-role="timer"]');
    if (timerEl){
      state.timers[c.id] = { el:timerEl, startedAt: c.statusSince ? new Date(c.statusSince).getTime() : Date.now(), dangerous };
    }
    return el;
  }

  function updateTimers(){
    const now = Date.now();
    Object.keys(state.timers).forEach(id=>{
      const t = state.timers[id];
      const sec = msToSec(now - t.startedAt);
      if (t.el) t.el.textContent = fmtTime(sec);
    });
  }

  function enableDrop(dropEl){
    dropEl.addEventListener('dragover', e=>{ e.preventDefault(); dropEl.style.outline='1px dashed var(--accent)'; dropEl.style.outlineOffset='-3px'; });
    dropEl.addEventListener('dragleave', ()=>{ dropEl.style.outline='none'; });
    dropEl.addEventListener('drop', async e=>{
      e.preventDefault(); dropEl.style.outline='none';
      const id = e.dataTransfer.getData('text/plain'); if (!id) return;
      const newStatus = dropEl.dataset.status;
      await move(id, newStatus);
    });
  }

  async function move(id, newStatus){
    try{
      await api('/api/move', {
        method:'POST',
        body: JSON.stringify({ operatorId:id, newStatus })
      });
      await loadBoard();
    }catch(e){
      alert(e.message||'–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞');
    }
  }

  async function loadBoard(){
    try{
      const data = await api('/api/board',{ method:'GET' });
      state.cards = data.cards || [];
      const byStatus = {};
      state.statuses.forEach(s=> byStatus[s] = []);
      state.cards.forEach(c=>{
        if (!byStatus[c.status]) byStatus[c.status] = [];
        byStatus[c.status].push(c);
      });
      const onlineCount = state.cards.filter(c => c.isOnline).length;
      document.getElementById('onlineCount').textContent = String(onlineCount);
      document.getElementById('totalOperators').textContent = String(state.cards.length);
      renderSummary(byStatus);
      renderColumns(byStatus);
      state.timers = {};
      const res = data;
      const now = Date.now();
      (state.cards||[]).forEach(c=>{
        const timerEl = document.querySelector(`.card[data-id="${c.id}"] [data-role="timer"]`);
        if (!timerEl) return;
        const startedAt = c.statusSince ? new Date(c.statusSince).getTime() : now;
        const danger = (now - startedAt) > 15*60*1000;
        state.timers[c.id] = { el:timerEl, startedAt, dangerous: danger };
      });
    }catch(e){
      console.error(e);
    }
  }

  function updateClock(){
    const now = new Date();
    const timeEl = document.getElementById('clockTime');
    const dateEl = document.getElementById('clockDate');
    if (!timeEl || !dateEl) return;
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    timeEl.textContent = `${hh}:${mm}`;
    dateEl.textContent = now.toLocaleDateString('ru-RU',{ weekday:'short', day:'2-digit', month:'2-digit', year:'numeric' });
  }

  function initThemeSwitch(){
    const el = document.getElementById('themeSwitch');
    if (!el) return;
    el.addEventListener('click',()=>{
      const next = state.theme === 'dark' ? 'light' : 'dark';
      setTheme(next);
    });
  }

  function initLogin(){
    const session = loadSession();
    if (session && session.token){
      state.session = session;
      document.getElementById('login').style.display='none';
      document.getElementById('app').style.display='block';
      document.getElementById('myShiftLabel').textContent = session.shift||'‚Äî';
      loadBoard();
      return;
    }

    const loginEl = document.getElementById('login');
    const appEl = document.getElementById('app');
    loginEl.style.display='block';
    appEl.style.display='none';

    const codeInput = document.getElementById('code');
    const errorEl = document.getElementById('loginError');
    const btnLogin = document.getElementById('btnLogin');

    btnLogin.addEventListener('click', async ()=>{
      const code = codeInput.value.trim();
      if (!code){
        errorEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞';
        errorEl.style.display='block';
        return;
      }
      errorEl.style.display='none';
      try{
        const data = await api('/api/login', {
          method:'POST',
          body: JSON.stringify({ code })
        });
        saveSession(data.session);
        document.getElementById('myShiftLabel').textContent = data.session.shift||'‚Äî';
        document.getElementById('login').style.display='none';
        document.getElementById('app').style.display='block';
        loadBoard();
      }catch(e){
        errorEl.textContent = e.message||'–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
        errorEl.style.display='block';
      }
    });

    codeInput.addEventListener('keydown', e=>{
      if (e.key === 'Enter'){
        btnLogin.click();
      }
    });
  }

  function initLogout(){
    const btnLogout = document.getElementById('btnLogout');
    if (!btnLogout) return;
    btnLogout.addEventListener('click',()=>{
      clearSession();
      location.reload();
    });
  }

  async function handleAddImage(c){
    try{
      const fileUrl = prompt('–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (JPG/PNG):', c.avatar||'');
      if (!fileUrl) return;
      await api('/api/addImage', {
        method:'POST',
        body: JSON.stringify({ operatorId:c.id, imageUrl:fileUrl })
      });
      await loadBoard();
    }catch(e){
      alert(e.message||'–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
    }
  }

  function initManualRefresh(){
    const btn = document.getElementById('btnRefresh');
    if (!btn) return;
    btn.addEventListener('click', ()=>{
      loadBoard();
    });
  }

  function initThemeButtons(){
    const loginBtn = document.getElementById('btnThemeLogin');
    const mainBtn = document.getElementById('btnTheme');
    [loginBtn, mainBtn].forEach(btn=>{
      if (!btn) return;
      btn.addEventListener('click', ()=>{
        const next = state.theme === 'dark' ? 'light' : 'dark';
        setTheme(next);
      });
    });
  }

  function init(){
    initTheme();
    initThemeSwitch();
    initThemeButtons();
    initLogin();
    initLogout();
    initManualRefresh();
    setInterval(loadBoard, 10000);
    setInterval(updateTimers, 1000);
    updateClock();
    setInterval(updateClock, 30000);
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>

</body>
</html>
